<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zentrova RAG Voice Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
      display: grid;
      gap: 24px;
    }

    h1 {
      text-align: center;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 15px;
      margin-top: -12px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-weight: 600;
      color: #111827;
      font-size: 14px;
    }

    input[type="text"], select {
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      transition: all 0.2s ease;
      background: white;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 16px 20px;
      font-size: 15px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    button.danger {
      background: linear-gradient(135deg, #f43f5e, #dc2626);
      color: white;
      box-shadow: 0 10px 25px rgba(244, 63, 94, 0.4);
    }

    button:disabled {
      cursor: not-allowed;
      filter: saturate(0.4) brightness(0.9);
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(102, 126, 234, 0.5);
    }

    .status {
      border-radius: 14px;
      padding: 16px 18px;
      background: rgba(241, 245, 249, 0.9);
      color: #0f172a;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .status[data-state="connecting"] {
      background: rgba(251, 191, 36, 0.2);
      color: #92400e;
      border: 2px solid rgba(251, 191, 36, 0.4);
    }

    .status[data-state="connected"] {
      background: rgba(34, 197, 94, 0.2);
      color: #166534;
      border: 2px solid rgba(34, 197, 94, 0.4);
    }

    .status[data-state="error"] {
      background: rgba(239, 68, 68, 0.2);
      color: #991b1b;
      border: 2px solid rgba(239, 68, 68, 0.4);
    }

    .status[data-state="searching"] {
      background: rgba(59, 130, 246, 0.2);
      color: #1e40af;
      border: 2px solid rgba(59, 130, 246, 0.4);
    }

    textarea {
      border: 2px solid rgba(148, 163, 184, 0.35);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 15px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    textarea:disabled {
      background: rgba(241, 245, 249, 0.6);
      cursor: not-allowed;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .audio-indicator {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 12px;
    }

    .audio-indicator.active {
      display: flex;
    }

    .audio-indicator span {
      width: 6px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      animation: pulse 1s ease-in-out infinite;
    }

    .audio-indicator span:nth-child(2) { animation-delay: 0.15s; }
    .audio-indicator span:nth-child(3) { animation-delay: 0.3s; }
    .audio-indicator span:nth-child(4) { animation-delay: 0.45s; }

    @keyframes pulse {
      0%, 100% { height: 12px; }
      50% { height: 32px; }
    }

    .rag-info {
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 13px;
      color: #1e40af;
      line-height: 1.6;
      display: none;
    }

    .rag-info.active {
      display: block;
    }

    .rag-info strong {
      display: block;
      margin-bottom: 6px;
      color: #1e3a8a;
    }

    .events-log {
      background: rgba(241, 245, 249, 0.9);
      border-radius: 16px;
      padding: 16px;
      max-height: 280px;
      overflow-y: auto;
      font-family: "JetBrains Mono", "Fira Code", "Courier New", monospace;
      font-size: 12px;
      color: #1f2937;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
    }

    .events-log div {
      background: white;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      line-height: 1.4;
      word-break: break-word;
    }

    .events-log div.function-call {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
      border-left: 4px solid #3b82f6;
    }

    .events-log div.error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
      border-left: 4px solid #ef4444;
    }

    audio { display: none; }

    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: -8px;
    }

    .custom-api-config {
      background: rgba(249, 250, 251, 0.9);
      border-radius: 14px;
      padding: 18px;
      border: 2px dashed rgba(148, 163, 184, 0.4);
    }

    .custom-api-config.has-apis {
      border-color: rgba(102, 126, 234, 0.5);
      background: rgba(102, 126, 234, 0.05);
    }

    .api-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .api-item {
      background: white;
      border-radius: 10px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .api-item-info {
      flex: 1;
    }

    .api-item-name {
      font-weight: 600;
      color: #111827;
      font-size: 14px;
    }

    .api-item-desc {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .api-item-remove {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .api-item-remove:hover {
      background: #dc2626;
    }

    .add-api-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .add-api-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #111827;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .form-label {
      font-weight: 600;
      font-size: 13px;
      color: #374151;
    }

    .form-input {
      border: 2px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .tools-enabled {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 13px;
      color: #065f46;
      display: none;
    }

    .tools-enabled.active {
      display: block;
    }

    .tools-enabled strong {
      display: block;
      margin-bottom: 6px;
      color: #047857;
    }
  </style>
</head>
<body>
  <div class="card">
    <div>
      <h1>üß† RAG Voice Assistant</h1>
      <p class="subtitle">Voice conversation with intelligent knowledge retrieval & custom APIs</p>
    </div>

    <label>
      Agent ID
      <input type="text" id="agentId" placeholder="Enter your agent ID" />
    </label>

    <label>
      Language
      <select id="language">
        <option value="English">English</option>
        <option value="Spanish">Spanish</option>
        <option value="French">French</option>
        <option value="German">German</option>
        <option value="Portuguese">Portuguese</option>
        <option value="Italian">Italian</option>
        <option value="Chinese">Chinese</option>
        <option value="Japanese">Japanese</option>
      </select>
    </label>

    <label>
      Welcome Message
      <input type="text" id="welcomeMessage" placeholder="Hello! How can I assist you today?" value="Hello! How can I assist you today?" />
    </label>

    <div class="custom-api-config" id="customApiConfig">
      <div class="section-title">üîå Custom API Tools</div>
      <div class="api-list" id="apiList"></div>
      <button class="add-api-btn" id="addApiBtn">+ Add Custom API</button>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="enableRag" checked />
      <label for="enableRag">Enable RAG Knowledge Base Search</label>
    </div>

    <div class="controls">
      <button class="primary" id="startBtn">Start Call</button>
      <button class="danger" id="stopBtn" disabled>End Call</button>
    </div>

    <div class="status" id="status" data-state="idle">Enter your agent ID and press Start Call.</div>

    <div class="audio-indicator" id="audioIndicator" aria-label="Assistant speaking">
      <span></span><span></span><span></span><span></span>
    </div>

    <div class="rag-info" id="ragInfo">
      <strong>üîç Knowledge Base Search</strong>
      <span id="ragInfoText">Searching for relevant information...</span>
    </div>

    <div class="tools-enabled" id="toolsEnabled">
      <strong>üõ†Ô∏è Tools Enabled</strong>
      <span id="toolsEnabledList">None</span>
    </div>

    <label>
      Send a Text Message
      <textarea id="messageInput" placeholder="Type a message and press Send" disabled></textarea>
    </label>
    <button class="primary" id="sendBtn" disabled>Send Text</button>

    <div>
      <div class="section-title">üìã Events & Function Calls</div>
      <div class="events-log" id="events"></div>
    </div>
  </div>

  <!-- Custom API Modal -->
  <div class="modal" id="apiModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Custom API Tool</h2>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Function Name *</label>
        <input type="text" class="form-input" id="apiName" placeholder="e.g., get_weather" />
      </div>

      <div class="form-group">
        <label class="form-label">Description *</label>
        <textarea class="form-input" id="apiDescription" rows="3" placeholder="Describe what this API does and when to use it"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">API URL *</label>
        <input type="text" class="form-input" id="apiUrl" placeholder="https://api.example.com/endpoint" />
      </div>

      <div class="form-group">
        <label class="form-label">HTTP Method</label>
        <select class="form-input" id="apiMethod">
          <option value="GET">GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="DELETE">DELETE</option>
          <option value="PATCH">PATCH</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Headers (JSON format)</label>
        <textarea class="form-input" id="apiHeaders" rows="3" placeholder='{"Authorization": "Bearer TOKEN"}'></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Query Parameters (JSON format)</label>
        <textarea class="form-input" id="apiQueryParams" rows="2" placeholder='{"key": "value"}'></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Request Body (JSON format)</label>
        <textarea class="form-input" id="apiRequestBody" rows="3" placeholder='{"field": "value"}'></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Response Path (JSONPath, optional)</label>
        <input type="text" class="form-input" id="apiResponsePath" placeholder="e.g., data.results" />
      </div>

      <div class="form-group">
        <label class="form-label">Parameters Schema (JSON format)</label>
        <textarea class="form-input" id="apiParameters" rows="8" placeholder='{"type": "object", "properties": {"city": {"type": "string", "description": "City name"}}, "required": ["city"]}'></textarea>
      </div>

      <button class="primary" id="saveApiBtn" style="width: 100%; margin-top: 10px;">Save API Tool</button>
    </div>
  </div>

  <audio id="assistantAudio" autoplay></audio>

  <script>
    const agentInput = document.getElementById('agentId');
    const languageSelect = document.getElementById('language');
    const welcomeMessageInput = document.getElementById('welcomeMessage');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const eventsEl = document.getElementById('events');
    const audioIndicator = document.getElementById('audioIndicator');
    const assistantAudio = document.getElementById('assistantAudio');
    const ragInfo = document.getElementById('ragInfo');
    const ragInfoText = document.getElementById('ragInfoText');
    const enableRagCheckbox = document.getElementById('enableRag');
    const customApiConfig = document.getElementById('customApiConfig');
    const apiList = document.getElementById('apiList');
    const addApiBtn = document.getElementById('addApiBtn');
    const apiModal = document.getElementById('apiModal');
    const modalClose = document.getElementById('modalClose');
    const saveApiBtn = document.getElementById('saveApiBtn');
    const toolsEnabled = document.getElementById('toolsEnabled');
    const toolsEnabledList = document.getElementById('toolsEnabledList');

    let pc = null;
    let dataChannel = null;
    let localStream = null;
    let currentAgentId = null;
    let customApis = [];

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      if (type === 'function') {
        entry.className = 'function-call';
      } else if (type === 'error') {
        entry.className = 'error';
      }
      entry.textContent = `${new Date().toLocaleTimeString()} ‚Äî ${message}`;
      eventsEl.prepend(entry);
      while (eventsEl.children.length > 200) {
        eventsEl.removeChild(eventsEl.lastChild);
      }
    }

    function setStatus(state, message) {
      statusEl.dataset.state = state;
      statusEl.textContent = message;
    }

    function showRAGInfo(text) {
      ragInfoText.textContent = text;
      ragInfo.classList.add('active');
      setTimeout(() => {
        ragInfo.classList.remove('active');
      }, 5000);
    }

    async function fetchEphemeralToken(agentId, language, welcomeMessage, enableRag, customApis) {
      const url = 'https://zentrova-chatbot.mygrantgenie.com/realtime/token';
      
      const requestBody = {
        voice: 'alloy',
        agent_id: agentId || null,
        language: language || 'English',
        welcome_message: welcomeMessage || 'Hello! How can I assist you today?',
        enable_rag: enableRag,
        custom_apis: customApis
      };

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to obtain token: ${errorText}`);
      }
      const payload = await response.json();
      if (!payload.value) {
        throw new Error('Token response missing value field');
      }
      
      // Display enabled tools
      if (payload.tools_enabled && payload.tools_enabled.length > 0) {
        toolsEnabledList.textContent = payload.tools_enabled.join(', ');
        toolsEnabled.classList.add('active');
      }
      
      return payload.value;
    }

    async function handleFunctionCall(functionName, functionCallId, args) {
      log(`üîß Function call: ${functionName}`, 'function');
      
      try {
        const parsedArgs = JSON.parse(args);
        log(`üìù Args: ${JSON.stringify(parsedArgs)}`, 'function');

        if (functionName === 'search_knowledge_base') {
          showRAGInfo(`Searching: "${parsedArgs.query}"`);
          setStatus('searching', 'üîç Searching knowledge base...');
        } else {
          // Custom API call
          setStatus('searching', `üîå Calling ${functionName}...`);
          showRAGInfo(`Executing: ${functionName}`);
        }

        // Call the backend function endpoint (handles both RAG and custom APIs)
        const response = await fetch('/realtime/function-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            function_name: functionName,
            arguments: parsedArgs
          })
        });

        if (!response.ok) {
          throw new Error(`Function call failed: ${response.statusText}`);
        }

        const result = await response.json();
        
        // Log results based on function type
        if (functionName === 'search_knowledge_base') {
          log(`‚úÖ Found ${result.count} results`, 'function');
          showRAGInfo(`Found ${result.count} relevant document(s)`);
          setStatus('connected', '‚ú® Knowledge retrieved successfully');
        } else {
          log(`‚úÖ ${functionName} completed`, 'function');
          showRAGInfo(`${functionName} executed successfully`);
          setStatus('connected', '‚ú® API call completed');
        }

        // Send function output back to the realtime session
        if (dataChannel && dataChannel.readyState === 'open') {
          const outputEvent = {
            type: 'conversation.item.create',
            item: {
              type: 'function_call_output',
              call_id: functionCallId,
              output: JSON.stringify(result)
            }
          };
          dataChannel.send(JSON.stringify(outputEvent));

          // Trigger response generation
          dataChannel.send(JSON.stringify({ type: 'response.create' }));
        }
      } catch (error) {
        log(`‚ùå Function error: ${error.message}`, 'error');
        setStatus('error', 'Function call failed');

        // Send error back to session
        if (dataChannel && dataChannel.readyState === 'open') {
          const outputEvent = {
            type: 'conversation.item.create',
            item: {
              type: 'function_call_output',
              call_id: functionCallId,
              output: JSON.stringify({ error: error.message })
            }
          };
          dataChannel.send(JSON.stringify(outputEvent));
        }
      }
    }

    async function startCall() {
      const agentId = agentInput.value.trim();
      const language = languageSelect.value;
      const welcomeMessage = welcomeMessageInput.value.trim() || "Hello! How can I assist you today?";
      const enableRag = enableRagCheckbox.checked;

      currentAgentId = agentId;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      messageInput.disabled = true;
      sendBtn.disabled = true;
      setStatus('connecting', 'Requesting token...');
      
      const toolsCount = customApis.length + (enableRag && agentId ? 1 : 0);
      log(`üöÄ Starting call with ${toolsCount} tool(s) (Language: ${language})...`);

      try {
        const ephemeralKey = await fetchEphemeralToken(agentId, language, welcomeMessage, enableRag, customApis);
        log('üîë Ephemeral token received');

        pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
        });

        pc.ontrack = (event) => {
          log('üéµ Received remote audio track');
          assistantAudio.srcObject = event.streams[0];
          assistantAudio.play().catch((err) => log(`Audio play error: ${err.message}`, 'error'));
          audioIndicator.classList.add('active');
        };

        pc.oniceconnectionstatechange = () => {
          log(`üßä ICE state: ${pc.iceConnectionState}`);
          if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
            setStatus('error', 'Connection lost');
            audioIndicator.classList.remove('active');
          }
        };

        log('üé§ Requesting microphone');
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
        log('‚úÖ Microphone access granted');

        dataChannel = pc.createDataChannel('oai-events');
        dataChannel.onopen = () => {
          log('üì° Data channel open');
          const toolsText = toolsCount > 0 ? `with ${toolsCount} tool(s)` : 'without tools';
          setStatus('connected', `‚úÖ Connected ${toolsText} (${language})`);
          messageInput.disabled = false;
          sendBtn.disabled = false;

          // Initial greeting - trigger the welcome message
          const initEvent = {
            type: 'response.create'
          };
          dataChannel.send(JSON.stringify(initEvent));
        };

        dataChannel.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            
            // Log important events
            if (payload.type === 'response.audio.delta') {
              audioIndicator.classList.add('active');
            } else if (payload.type === 'response.audio.done') {
              audioIndicator.classList.remove('active');
            } else if (payload.type === 'response.function_call_arguments.done') {
              // Function call detected
              const functionName = payload.name;
              const functionCallId = payload.call_id;
              const args = payload.arguments;
              handleFunctionCall(functionName, functionCallId, args);
            } else if (payload.type === 'response.done') {
              log('üí¨ Response completed');
              setStatus('connected', '‚úÖ Ready for next question');
            } else if (payload.type === 'error') {
              log(`‚ùå Error: ${payload.error?.message || 'Unknown error'}`, 'error');
            }
          } catch (err) {
            // Non-JSON message
            log(`üì® Binary/non-JSON message received`);
          }
        };

        dataChannel.onerror = (error) => {
          log(`‚ùå Data channel error: ${error}`, 'error');
          setStatus('error', 'Data channel error');
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        log('üì§ Sending SDP to OpenAI');
        const sdpResponse = await fetch('https://api.openai.com/v1/realtime/calls', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${ephemeralKey}`,
            'Content-Type': 'application/sdp',
          },
          body: offer.sdp,
        });

        if (!sdpResponse.ok) {
          const errText = await sdpResponse.text();
          throw new Error(`OpenAI SDP error ${sdpResponse.status}: ${errText}`);
        }

        const answer = await sdpResponse.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answer });
        log('‚úÖ Call established with RAG capabilities');
      } catch (error) {
        log(`‚ùå Error starting call: ${error.message}`, 'error');
        setStatus('error', error.message);
        cleanup();
      }
    }

    function sendText() {
      if (!dataChannel || dataChannel.readyState !== 'open') return;
      const text = messageInput.value.trim();
      if (!text) return;

      const createEvent = {
        type: 'conversation.item.create',
        item: {
          type: 'message',
          role: 'user',
          content: [
            {
              type: 'input_text',
              text,
            },
          ],
        },
      };

      dataChannel.send(JSON.stringify(createEvent));
      dataChannel.send(JSON.stringify({ 
        type: 'response.create',
        response: {
          instructions: 'Respond in English unless the user specifically asks for another language.'
        }
      }));
      log(`üì§ Sent text: ${text}`);
      messageInput.value = '';
    }

    function cleanup() {
      if (dataChannel) {
        try { dataChannel.close(); } catch (_) {}
        dataChannel = null;
      }
      if (pc) {
        try { pc.close(); } catch (_) {}
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach((track) => track.stop());
        localStream = null;
      }
      audioIndicator.classList.remove('active');
      ragInfo.classList.remove('active');
      assistantAudio.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      messageInput.disabled = true;
      sendBtn.disabled = true;
      currentAgentId = null;
    }

    function stopCall() {
      log('üõë Ending call');
      cleanup();
      setStatus('idle', 'Call ended. Enter an agent ID to start again.');
    }

    // Custom API Management
    function renderApiList() {
      apiList.innerHTML = '';
      
      if (customApis.length === 0) {
        apiList.innerHTML = '<p style="color: #6b7280; font-size: 13px; padding: 8px;">No custom APIs configured. Click "Add Custom API" to get started.</p>';
        customApiConfig.classList.remove('has-apis');
      } else {
        customApiConfig.classList.add('has-apis');
        customApis.forEach((api, index) => {
          const item = document.createElement('div');
          item.className = 'api-item';
          item.innerHTML = `
            <div class="api-item-info">
              <div class="api-item-name">${api.name}</div>
              <div class="api-item-desc">${api.description}</div>
            </div>
            <button class="api-item-remove" data-index="${index}">Remove</button>
          `;
          apiList.appendChild(item);
        });

        // Add remove handlers
        document.querySelectorAll('.api-item-remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            customApis.splice(index, 1);
            renderApiList();
            log(`üóëÔ∏è Removed custom API`);
          });
        });
      }
    }

    function openApiModal() {
      apiModal.classList.add('active');
      // Clear form
      document.getElementById('apiName').value = '';
      document.getElementById('apiDescription').value = '';
      document.getElementById('apiUrl').value = '';
      document.getElementById('apiMethod').value = 'GET';
      document.getElementById('apiHeaders').value = '';
      document.getElementById('apiQueryParams').value = '';
      document.getElementById('apiRequestBody').value = '';
      document.getElementById('apiResponsePath').value = '';
      document.getElementById('apiParameters').value = '';
    }

    function closeApiModal() {
      apiModal.classList.remove('active');
    }

    function saveCustomApi() {
      const name = document.getElementById('apiName').value.trim();
      const description = document.getElementById('apiDescription').value.trim();
      const url = document.getElementById('apiUrl').value.trim();
      const method = document.getElementById('apiMethod').value;
      const headersText = document.getElementById('apiHeaders').value.trim();
      const queryParamsText = document.getElementById('apiQueryParams').value.trim();
      const requestBodyText = document.getElementById('apiRequestBody').value.trim();
      const responsePath = document.getElementById('apiResponsePath').value.trim();
      const parametersText = document.getElementById('apiParameters').value.trim();

      // Validation
      if (!name) {
        alert('Function name is required');
        return;
      }
      if (!description) {
        alert('Description is required');
        return;
      }
      if (!url) {
        alert('API URL is required');
        return;
      }

      // Check for duplicate names
      if (customApis.some(api => api.name === name)) {
        alert('A custom API with this name already exists');
        return;
      }

      try {
        const apiConfig = {
          name,
          description,
          url,
          request_method: method,
        };

        // Parse JSON fields
        if (headersText) {
          apiConfig.headers = JSON.parse(headersText);
        }
        if (queryParamsText) {
          apiConfig.query_params = JSON.parse(queryParamsText);
        }
        if (requestBodyText) {
          apiConfig.request_body = JSON.parse(requestBodyText);
        }
        if (responsePath) {
          apiConfig.response_path = responsePath;
        }
        if (parametersText) {
          apiConfig.parameters = JSON.parse(parametersText);
        }

        customApis.push(apiConfig);
        renderApiList();
        closeApiModal();
        log(`‚úÖ Added custom API: ${name}`);
      } catch (error) {
        alert(`Invalid JSON format: ${error.message}`);
      }
    }

    // Event Listeners
    startBtn.addEventListener('click', startCall);
    stopBtn.addEventListener('click', stopCall);
    sendBtn.addEventListener('click', sendText);
    addApiBtn.addEventListener('click', openApiModal);
    modalClose.addEventListener('click', closeApiModal);
    saveApiBtn.addEventListener('click', saveCustomApi);
    
    messageInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendText();
      }
    });

    // Close modal on background click
    apiModal.addEventListener('click', (event) => {
      if (event.target === apiModal) {
        closeApiModal();
      }
    });

    window.addEventListener('beforeunload', () => {
      cleanup();
    });

    // Initialize
    renderApiList();
  </script>
</body>
</html>
